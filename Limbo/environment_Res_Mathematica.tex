\startenvironment environment_Res_Mathematica
\project project_Res_Mathematica



\let\Q\left
\let\W\right
\let\ob\mathbb

%\setuplayout[...]



\startluacode
	userdata = userdata or { }
	records = { }
	function userdata.remember(str)
		table.insert(records, str)
	end
\stopluacode

\def\R{\dostartbuffer[record][R][S]}
\def\U{\groupedcommand{aa}{bb}}
%\def\R{\dostartbuffer[record][startrecord][stoprecord]}



%\def\S{\ctxlua{thirddata.foo.clean_lines(buffers.getcontent('foo'))}}
%\def\R#1{\dostartbuffer[record][R][S]#1\ctxlua{userdata.remember(buffers.getcontent('record'))}}%
%\def\R#1{\dostartbuffer[record][R][S]#1\ctxlua{userdata.remember(buffers.getcontent('record'))}}%
\def\S{\ctxlua{userdata.remember(buffers.getcontent('record'))}}%
%\def\T#1\T{\startbuffer['record']#1\stopbuffer\ctxlua{userdata.remember(buffers.getcontent('record'))}}


%\def\T#1\T{#1\ctxlua{userdata.remember("\luaescapestring{#1}")}}


%%%% Maths
\unprotect
\def\Définition{\dosingleargument\do@Définition}%
\def\do@Définition[#1]#2\par{{\getparameters[??LD][#1]}Définition. \ignorespaces #2\medskip}%

\def\Propriété{\dosingleargument\do@Propriété}%
\def\do@Propriété[#1]#2\par{{\getparameters[??LD][#1]}Propriété. \ignorespaces #2\medskip}%

\def\Théorème{\dosingleargument\do@Théorème}%
\def\do@Théorème[#1]#2\par{{\getparameters[??LD][#1]}Théorème. \ignorespaces #2\medskip}%


\newcount\RecordCount\global\RecordCount0\relax
\def\ShowR{\startcolumns[n=2,rule=on]\ctxlua{for i=1,\the\RecordCount,1 do context("\\csname Record"..i.."\\endcsname\\crlf") end}\stopcolumns}
\def\R{\dosingleargument\do@R}%
\def\do@R[#1]#2\R{#2{\getparameters[??LD][#1]%
	\ifx\??LDtitle\undefined\def\Record{#2}\else\@EA\def\@EA\Record\@EA{\@EA\framed\@EA{\??LDtitle}#2}\fi
	\global\advance\RecordCount1\relax\edef\temp{Record\the\RecordCount}\@EA\@EA\@EA\gdef\@EA\csname\@EA\temp\@EA\endcsname\@EA{\Record}}%
}%
\protect

\unprotect



\def\T#1\T{#1\global\advance\RecordCount1\relax\@EA\gdef\csname Record\the\RecordCount\endcsname{#1}}%

\protect


\def\Show{\startcolumns[n=2,rule=on]\ctxlua{for i,v in ipairs(records) do context("\\crlf") context(v) end}\stopcolumns
}%
\def\Z#1\Z{\startmode[book]#1\stopmode}%
\def\Y#1\Y{\startmode[slide]#1\stopmode}%




\stopenvironment
