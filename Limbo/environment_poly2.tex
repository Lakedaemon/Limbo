\startenvironment environment_poly
\directlua{dofile("Limbo.lua")}
\unprotect
% setups for poly

\startxmlsetups xml:poly
\xmlsetsetup{poly}{*}{-}
% root
\xmlsetsetup{poly}{root}{xml:poly:flush}
% sectioning
\xmlsetsetup{poly}{domain|chapter|section|subsection|subsubsection|concept}{xml:poly:group}
% context
\xmlsetsetup{poly}{context}{xml:poly:context}
% grouping 
\xmlsetsetup{poly}{group}{xml:poly:group}
\xmlsetsetup{poly}{combination}{xml:poly:combination}
%\xmlsetsetup{maths}{combination/property}{xml:combination/statement}
% statements (primary objects)
\xmlsetsetup{poly}{corollary|definition|lemma|notation|property|theorem|}{xml:poly:statement} 
% best practice (secondary info)
\xmlsetsetup{poly}{craft|uses|item}{xml:poly:*}
% illustration
\xmlsetsetup{poly}{figure|example}{xml:poly:*} 
% text (tertiary info)
\xmlsetsetup{poly}{remark|remarks|text}{xml:poly:*} 
%\xmlsetsetup{#1}{remarks/remark}{xml:poly:remarks:remark} 
% exercises
\xmlsetsetup{poly}{exercise}{xml:poly:*}
% proofs
\xmlsetsetup{poly}{proof}{xml:poly:*}

\stopxmlsetups 

\xmlregistersetup{xml:poly} 

\startxmlsetups xml:poly:flush
\xmlflush{#1}%
\stopxmlsetups

\startxmlsetups xml:poly:craft
\ctxlua{L.processNewStatement("#1")}%
\stopxmlsetups

% example

\startxmlsetups xml:poly:example
\ctxlua{L.processExample("#1")}%
\stopxmlsetups


\startxmlsetups xml:poly:group
\ctxlua{L.processGroup("#1")}%
\stopxmlsetups

\startxmlsetups xml:poly:context
\ctxlua{L.processRawContent("#1")}%
\stopxmlsetups

\startxmlsetups xml:poly:statement
\ctxlua{L.processNewStatement("#1")}%
%\placeleftfigure{}{\useMPgraphic{Frame}}%
\stopxmlsetups

\startxmlsetups xml:poly:combination
%\ctxlua{L.processCombination("#1")}%
\xmlflush{##1}%
\stopxmlsetups

%exercices

\startxmlsetups xml:poly:exercise
\ctxlua{L.processExercise("#1")}%
\stopxmlsetups

\startxmlsetups xml:poly:figure
\ctxlua{L.processFigure("#1")}%
\stopxmlsetups

% proofs
\startxmlsetups xml:poly:proof
\ctxlua{L.processProof("#1")}%
\stopxmlsetups

% remarks
\startxmlsetups xml:poly:remark
\ctxlua{L.processRemark("#1")}%
\stopxmlsetups

\startxmlsetups xml:poly:remarks 
{\tenpoint\startitemize[packed,intext,joinedup,2,nowhite,after]%
\xmlflush{#1}%
\stopitemize}%
\stopxmlsetups

\startxmlsetups xml:poly:remarks:remark
\item\ctxlua{L.processRawContent("#1")}%
\stopxmlsetups

% texts

\startxmlsetups xml:poly:text
\ctxlua{L.processRawContent("#1")}%
\stopxmlsetups

\startxmlsetups xml:poly:uses
{\tenpoint
\startitemize[packed,intext,joinedup,4,nowhite,after]
\xmlflush{#1}%
\stopitemize}
\stopxmlsetups


\startxmlsetups xml:poly:item
\ctxlua{L.processContent("#1","\\item")}%
\stopxmlsetups

\startxmlsetups xml:poly:flushsidefloats
\flushsidefloats
\stopxmlsetups


\protect
\stopenvironment
