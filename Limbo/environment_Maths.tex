\startenvironment environment_Maths
\unprotect
%%% todo

% ? context way to type
%
%\startformula
%\eqalign{
%ℜe(λs+μz)&=λℜe(s)+μℜe(z)\cr
%ℑm(λs+μz)&=λℑm(s)+μℑm(z)\cr
%}\qquad(λ, μ, s, z) ∈ ℝ^2×ℂ^2
%\stopformula
%

% ? use \startalign inside \Eq

% ? fix CDATA

% trim spaces



% setup
\mainlanguage[fr]
\fr

\definefloat[centeredTable][centeredTables][table]
\setupfloat[centeredTable][default={fixed,none}]
\setupinmargin[style=\bfxx\setupinterlinespace]
\usemodule[tikz]
%\usetikzlibrary{patterns}
%\usemodule[pstricks]
%\usePSTRICKSmodule[pst-barcode]


\def\SetupHypotheses#1#2{\doifemptyelse{#2}{\setupMPvariables[#1][Hypotheses=0]}{\setupMPvariables[#1][Hypotheses=1]\setMPtext{Hypotheses}{\hbox spread 1em{\hss\strut#2\hss}}}}


%\def\App#1:#2→#3:#4→#5\ppA{\Eq[C,C,C,C]{
%\NC #1:\NC #2\NC \to\NC #3\NC\NR
%\NC\NC #4\NC \mapsto\NC #5\NC\NR}
%}

%%  obsolete
%\let\ob\mathbb

\def\e{{\rm e}}%
%% beware
\def\d{{\rm d}}%
\def\≢{\not\equiv}%
\def\ssi{{\it ssi} }

\long\def\Application : #1\par{\noindent{\eightpts{\it Application : }#1}\medskip}%

\def\Center#1{\placecenteredTable{}{#1}}%
\def\Conseil : #1\par{{%
	\eightpoint
	\noindent
	\llap{%
		$\underline{\mbox{Conseil}}$ : 
	}%
	#1\medskip
}}%
\def\CTab#1{\Center{\Tab{#1}}}%

\long\def\Démonstration. #1\CQFD{\noindent{\eightpoint Démonstration. #1}\bigskip}

\def\Eq{\dosingleargument\Eq@do}%
\def\Eq@process#1{%
	\def\c{}%
	\processaction[#1][
		r=>\def\c{rh\FramedCell|},%
		c=>\def\c{c|},
		C=>\def\c{cm|},
		*=>\let\Eq@Remember\relax]%
   %  default=>\relax,
    % unknown=>\unknown{... \commalistelement ...}
    %
\@EA\@EA\@EA\def\@EA\@EA\@EA\Eq@columns\@EA\@EA\@EA{\@EA\Eq@columns\c}
}%
\def\Eq@do[#1]#2{{\def\Eq@columns{|}\processcommalist[#1]\Eq@process
\ifx\Eq@Remember\undefined
	\@EA\CTab\@EA{\@EA[\Eq@columns]#2}\else
	\@EA\R\@EA{\@EA\CTab\@EA{\@EA[\Eq@columns]#2}}\fi
}}%



\def\Eqalign#1{\Matrix{[n=2,align={right,left}]#1}}%

\def\Et{\text{ et }}%
\def\EtQ{\quad\Et\quad}
\def\EtQQ{\qquad\Et\qquad}

\def\Exemple#1{{\tenpoint Exemple : #1\crlf\crlf}}
\def\Exercise#1{{\tenpoint Exercice : #1\crlf\crlf}}
%\def\Exemple{\def\Exemple@text{Exemple}\dosingleargument\Exemple@do}%
%\def\Exemple@do[#1]#2\par{{\getparameters[??LD][#1]}{\eightpoint\Exemple@text. \ignorespaces #2}\medskip}%
%\def\Exemples{\def\Exemple@text{Exemples}\dosingleargument\Exemple@do}%

\let\F\over
\def\Inframed#1{\inframed[toffset=-0.4ex,boffset=-0.4ex]{#1}}%

\def\Matrix#1{\startmatrix#1\stopmatrix}%
\def\Notation{\noindent{\it Notation}}%

% obsolete \less
\def\Le{<}

\def\Ou{\text{ ou }}%
\def\OuQ{\quad\Ou\quad}
\def\OuQQ{\qquad\Ou\qquad}

\def\Proof#1{{\tenpoint Preuve : #1\crlf\crlf}}

\startuniqueMPgraphic{Frame}{Hypotheses,Title,Value,Shape}
  numeric o, l, m ; path a, b ; pair c ; 
  o := BodyFontSize ;
  a := unitsquare xyscaled (OverlayWidth,OverlayHeight);
  l := OverlayLineWidth * 0.5 * \MPvar{Value};
  pickup pencircle scaled l ;
  b := a if  \MPvar{Shape} = 1: superellipsed .95; 
  elseif  \MPvar{Shape} = 0: squeezed 2pt; fi;
  fill b withcolor OverlayColor ;
  draw b withcolor OverlayLineColor ;
  setbounds currentpicture to a ;
  if \MPvar{Title} = 1:
    picture q ;
    q := textext.rt(\MPstring{Title}) ;
    if  \MPvar{Shape} = 1:
      q := q shifted (OverlayWidth/2-xpart center q,OverlayHeight + o/2 + 1pt + ypart center q);
      b := (boundingbox q)   superellipsed .95;  
    elseif  \MPvar{Shape} = 0:
        q := q shifted (OverlayWidth/2-xpart center q,OverlayHeight + ypart center q);
        b := (boundingbox q)  squeezed 2pt;  
    fi;
    fill b withcolor OverlayColor ;
    pickup pencircle scaled  (OverlayLineWidth * 0.5);
    draw b withcolor OverlayLineColor ;
    draw q withcolor black ;
  fi;
  if \MPvar{Hypotheses} = 1:
    picture p ;
    p := textext.rt(\MPstring{Hypotheses}) ;
    p := p shifted (OverlayWidth/2-xpart center p,0) ;
    b := (boundingbox p) if  \MPvar{Shape} = 1: superellipsed .95; 
     elseif  \MPvar{Shape} = 0: squeezed 2pt; fi;
    fill b withcolor OverlayColor ;
    pickup pencircle scaled  (OverlayLineWidth * 0.5);
    draw b withcolor OverlayLineColor ;
    draw p withcolor black ;
  fi;
\stopuniqueMPgraphic    

\defineoverlay[OverlayStatement][\useMPgraphic{Frame}]
\setupframedtexts[Statement][backgroundcolor=lightgray,framecolor=darkred,rulethickness=2pt,offset=\bodyfontsize,before={\blank[big,medium]},after={\blank[big]},width=\textwidth,autowidth=force,location=lohi]

\defineframedtext[Statement][frame=off,background=OverlayStatement]

\setupframedtexts[S][width=\textwidth,autowidth=force]
\defineframedtext[S][frame=off]


\let\Q\left

\def\Rappel : #1\par{{%
	\eightpoint
	\noindent
	\llap{%
		$\underline{\mbox{Rappel}}$ : 
	}%
	#1\medskip
}}%
\long\def\Rappels. #1\par{\noindent{\eightpoint{\it Rappels. }#1}\medskip}


\def\Remarque#1{\noindent{\it Remarque. }#1\crlf\crlf}%

%\def\Statement{\dosingleargument\Statement@do}%
%\long\def\Statement@do[#1]#2\par{\SetupHypotheses{Frame}{#1}\placefigure[right,nonumber]{}{\startStatement\ignorespaces #2\stopStatement}}%

\def\Tab#1{\starttabulate#1\stoptabulate}%

\def\VTab#1{\vcenter{\Tab{#1}}}%
\let\W\right

\protect
\stopenvironment
