\startenvironment environment_Maths
\unprotect

% modules
\usemodule[tikz]
\usemodule[database]
\usetikzlibrary[tkz-tab,petri,er,mindmap,arrows,trees,shapes,snakes,matrix,patterns,topaths,automata,backgrounds,plothandlers,plotmarks,fit,positioning,decorations.text]
%\usemodule[pstricks]
%\usePSTRICKSmodule[pst-barcode]
\tikzstyle{Tableau Operateur}= [matrix of nodes,ampersand replacement=\&,nodes={draw,text width=2cm,text height=10pt,inner ysep=3pt},column sep={2cm,between origins},row sep={16pt,between origins}]
\tikzstyle{Nested Picture}=[rectangle,rounded corners=0pt,anchor=center,text centered,text width=2cm, text height=10pt,inner xsep=0pt,inner ysep=4pt]


% language
\mainlanguage[fr]
\fr

%\catcode` =\active
%\def {\quad }
%\starttext ess ai\stoptext


\definesynonyms[abbreviation][abbreviations][\infull]
\abbreviation [SSI] {{\it ssi} } {si, et seulement si, }


% inmargin
\setupinmargin[style=\bfxx\setupinterlinespace]

%
\setupfloats[sidespacebefore=none,sidespaceafter=depth]

\definefloat[textfigure][textfigures][figure]
\definefloat[leftfigure][leftfigures][figure]
\definefloat[middlefigure][middlefigures][figure]
\definefloat[rightfigure][rightfigures][figure]

\setupfloat[textfigure][criterium=.5\textwidth, default={outer,none}]
\setupfloat[leftfigure][criterium=.7\textwidth, default={left,none,fit}]
\setupfloat[middlefigure][location=middle,default={none}]
\setupfloat[rightfigure][criterium=.5\textwidth,default={right,none,fit}]


\defineitemgroup[List][levels=4]
\setupitemgroup[List][1][R,joinedup,nowhite]
\setupitemgroup[List][2][n,joineup,nowhite]
\setupitemgroup[List][3][a,joineup,nowhite]
\setupitemgroup[List][4][1,joineup,nowhite]


\defineitemgroup[Set][levels=4]
\setupitemgroup[Set][1][1,joinedup,nowhite]
\setupitemgroup[Set][2][2,joineup,nowhite]
\setupitemgroup[Set][3][3,joineup,nowhite]
\setupitemgroup[Set][4][4,joineup,nowhite]

\setupfloat[marginfigure][criterium=.5\textwidth,maxwidth=\rightmarginwidth,default={outermargin,none}]
\setupfloat[middlemarginfigure][minwidth=\rightmarginwidth,criterium=\snijwit,location=middle,default={outermargin,none}]


\def\doFsubject#1#2{\framed{#2}\crlf}
\def\doFsubsubject#1#2{$\underline{\text{#2}}$\crlf}
\definehead[Fsubject][subject]
\setuphead[Fsubject][alternative=middle,before={\blank[small]},align=middle,after={\blank[small]},distance=0pt,command=\doFsubject,style=\tfa\ss\bf]%aligntitle=float,
\definehead[Fsubsubject][subsubject]
\setuphead[Fsubsubject][alternative=text,before={\blank[small]},distance=0pt,command=\doFsubsubject,style=\ss\bf]%aligntitle=float,



\definehead[Concept][subsubject]
\setuphead[Concept][alternative=text,before={\goodbreak\blank[small]},distance=0pt,command=\Concept,style=\ss\bf]%aligntitle=float,
\def\Concept#1{\inmargin{#1}}
%\def\Concept#1#2{\inmargin{#1 #2}}
\definefloat[statement][statements][figure]
%\flushsidefloats
%\forgetsidefloats

%\flushsidefloats
%\forgetsidefloats


%%%% for csv
% Iterate over all the lines of text captured with \obeylines active
% command to call is first argument, is not called for empty lines
\def\ProcessLines#1#2{\doProcessLines{#1}#2\\\doProcessLines}%
\def\doProcessLines#1#2\\#3\doProcessLines{%
 \doifnotempty{#2}{#1{#2}}%
 \doifnotempty{#3}{\doProcessLines{#1}#3\doProcessLines}%
}%



%%%% for tables
\def\TBLentry#1{\bTD #1\eTD}
\def\TBLline#1{\bTR\processcommalist[#1]\TBLentry}

\def\startCSV#1\stopCSV{\ProcessLines\TBLline{#1}}%

\def\Variations#1#2{\setupTABLE[r][each][align=center,frame=off]%
\setupTABLE[r][1,2,3][topframe=on]%
\setupTABLE[r][last][bottomframe=on]%
\setupTABLE[c][1,2][leftframe=on]%
\setupTABLE[c][last][rightframe=on]%
#1
\placetable[none,align=middle]{}{
\bTABLE
\startCSV
#2
\stopCSV
\eTABLE}
}%

%%% caveats :
% csv data may optionally be enclosed in "" quotes that have to be removed (to be done in \TBLentry)
% quoted strings may contain commas themselves (which means writing a custom version of \processcommalist instead).



%% a better way with 
\defineseparatedlist[AR][separator={,},before=\bTABLE,after=\eTABLE,first=\bTR,last=\eTR,left=\bTD,right=\eTD]
%\setupArray[r][each][align=center]

%% FIX this !
\def\≢{\not\equiv}%
\def\∉{\not\in}%





\def\arccos{\mathop{\rm Arccos}\nolimits}%
\def\arcsin{\mathop{\rm Arcsin}\nolimits}%
\def\arctan{\mathop{\rm Arctan}\nolimits}%
\def\argch{\mathop{\rm Argch}\nolimits}%
\def\argsh{\mathop{\rm Argsh}\nolimits}%
\def\argth{\mathop{\rm Argth}\nolimits}%
\def\card{\mathop{\rm card}\nolimits}%
\def\ch{\mathop{\rm ch}\nolimits}%
\def\completeRecords{\ctxlua{L.showRecords()}}%
\def\cotan{\mathop{\rm cotan}\nolimits}
\def\d{{\rm d}}%
\def\e{{\rm e}}%
\def\exo#1{\ctxlua{L.infernoDisplay("#1")}}%
\def\floor#1{\lfloor #1\rfloor}%
\def\function#1{\Function@doFour #1\End}%
\def\hint#1{\ctxlua{L.infernoDisplayHint("#1")}}%
\def\hypothesys#1{{\bf Dans toute cette section, nous nous donnons #1}\blank[small]}
\def\important#1{{\red #1}}%
\def\log{\mathop{\rm log}\nolimits}%
\def\max{\mathop{\rm max}\nolimits}%
\def\mc#1{{\mathcal #1}}%% \sc is small caps
\def\min{\mathop{\rm min}\nolimits}%
\def\rare#1{{\darkgray #1}}%
\def\rg{\mathop{\rm rg}\nolimits}%
\def\setupCourse#1{\ctxlua{L.setCourse("#1")}}
\def\sh{\mathop{\rm sh}\nolimits}%
\def\solution#1{\ctxlua{L.infernoDisplaySolution("#1")}}%
\def\ssi{{\it ssi} }%
\def\ssil{{\it ss'}}%
\def\ssm{\setminus}%

\definemathmatrix[Align][align={right,left}]%
\definemathmatrix[Choices][left={\left\vert\ \,},right={\right.}]%
\definemathmatrix[ChoicesR][left={\left.},right={\ \,\right\vert}]%

%\definemathmatrix[Bracket][left={\left[\,},right={\,\right]}]
%\definemathmatrix[Curly][left={\left\{\,},right={\,\right\}}]
\definemathmatrix[Det][left={\left\vert\,},right={\,\right\vert}]%
%\definemathmatrix[Function][align={right,center,center,center}]
\definemathmatrix[Matrix][left={\left(\,},right={\,\right)}]%
%\definemathmatrix[Norm][left={\left\Vert\,},right={\,\right\Vert}]
\definemathmatrix[System][left={\left\{\,},right={\right.}]%
\definemathmatrix[SystemR][left={\left.},right={\,\right\}}]%

	\definemathmatrix[Vector][align=center,left={\left(\,},right={\,\right)}]%







\def\th{\mathop{\rm th}\nolimits}%
\def\tg{\mathop{\rm tg}\nolimits}%



\def\Align#1{\startAlign #1 \stopAlign}%
\def\Avec{\text{ avec }}%
\def\AvecQ{\quad\Avec\quad}%
\def\AvecQQ{\qquad\Avec\qquad}%
\def\Card{\mathop{\rm Card}\nolimits}%
\def\Choices#1{\startChoices #1 \stopChoices}%
\def\ChoicesR#1{\startChoicesR #1 \stopChoicesR}%
\def\Det#1{\startDet #1 \stopDet}%
\def\Dim{\mathop{\rm dim}\nolimits}%
\def\DL{\mathop{\rm DL}\nolimits}%
\def\Et{\text{ et }}%
\def\EtQ{\quad\Et\quad}%
\def\EtQQ{\qquad\Et\qquad}%
\let\F\over
\def\I{{\rm I}}%

\def\startFunction #1\stopFunction{\Function{#1}}%
\def\Function#1{\Function@doFive #1\End}%
\def\Function@doFive #1:#2→#3|#4↦#5\End{%
  \startmatrix[align={right,middle,middle,middle}]%
  \NC #1:\NC #2\NC\to\NC #3\NR
  \NC\NC #4\NC\mapsto\NC #5\stopmatrix
}%
\def\Function@doFour #1→#2|#3↦#4\End{%
  \startmatrix%
  \NC #1\NC\to\NC #2\NR
  \NC #3\NC\mapsto\NC #4\stopmatrix
}%
\def\Grand{\text{ grand}}%
\def\Id{{\rm Id}}%
\def\IM{\mathop{\rm Im}\nolimits}%
\def\Ker{\mathop{\rm Ker}\nolimits}%
\let\L\limits
\def\Le{<}%
\def\Matrix#1{\startMatrix #1 \stopMatrix}%
\def\Non{\text{non }}%
\def\Ou{\text{ ou }}%
\def\OuQ{\quad\Ou\quad}%
\def\OuQQ{\qquad\Ou\qquad}%
\let\Q\left
\def\Quand{\text{ quand }}%
\def\Restr#1{\left.\kern-\nulldelimiterspace #1\vphantom{\big|}\right|}%
\def\Si{\text{ si }}%
\def\SiQ{\quad\Si\quad}%
\def\SiQQ{\qquad\Si\qquad}%
\def\Sinon{\text{sinon}}%
\def\System#1{\startSystem #1 \stopSystem}%
\def\SystemR#1{\startSystemR #1 \stopSystemR}%
\def\Tr{\mathop{\rm Tr}\nolimits}%
\def\trans#1{\strut^{\text{t}}#1}%
%\def\Transpose#1{\strut^{\text{t}}#1}
\def\Vect{\mathop{\rm Vect}\nolimits}%
\def\Vector#1{\startVector #1 \stopVector}%
\let\W\right











%% beware



\long\def\Application : #1\par{\noindent{\eightpts{\it Application : }#1}\medskip}%


\def\Center#1{\placecenteredTable{}{#1}}%
\def\Conseil : #1\par{{%
	\eightpoint
	\noindent
	\llap{%
		$\underline{\mbox{Conseil}}$ : 
	}%
	#1\medskip
}}%
\def\CTab#1{\Center{\Tab{#1}}}%

\long\def\Démonstration. #1\CQFD{\noindent{\eightpoint Démonstration. #1}\bigskip}%

\def\Eq{\dosingleargument\Eq@do}%
\def\Eq@process#1{%
	\def\c{}%
	\processaction[#1][%
		r=>\def\c{rh\FramedCell|},%
		c=>\def\c{c|},%
		C=>\def\c{cm|},%
		*=>\let\Eq@Remember\relax]%
   %  default=>\relax,
    % unknown=>\unknown{... \commalistelement ...}
    %
\@EA\@EA\@EA\def\@EA\@EA\@EA\Eq@columns\@EA\@EA\@EA{\@EA\Eq@columns\c}%
}%
\def\Eq@do[#1]#2{{\def\Eq@columns{|}\processcommalist[#1]\Eq@process
\ifx\Eq@Remember\undefined
	\@EA\CTab\@EA{\@EA[\Eq@columns]#2}\else
	\@EA\R\@EA{\@EA\CTab\@EA{\@EA[\Eq@columns]#2}}\fi
}}%



\def\Eqalign#1{\Matrix{[n=2,align={right,left}]#1}}%



\def\Exemple#1{{\tenpoint Exemple : #1\crlf\crlf}}%
%\def\Exemple#1{\startitemize[packed,intext,joinedup,nowhite,after]{\tenpoint Exemple : #1}\stopitemize}
%\startfiguretext[][]{}\stopfiguretext
\def\Exercise#1{{\tenpoint Exercice : #1\crlf\crlf}}%
%\def\Exemple{\def\Exemple@text{Exemple}\dosingleargument\Exemple@do}%
%\def\Exemple@do[#1]#2\par{{\getparameters[??LD][#1]}{\eightpoint\Exemple@text. \ignorespaces #2}\medskip}%
%\def\Exemples{\def\Exemple@text{Exemples}\dosingleargument\Exemple@do}%



\def\Inframed#1{\inframed[toffset=-0.4ex,boffset=-0.4ex]{#1}}%

\def\Notation{\noindent{\it Notation}}%




\def\Proof#1{{\tenpoint Preuve : #1\crlf\crlf}}%

\startusableMPgraphic{Frame}{Hypotheses,Title,Value,Shape,IsOverlay}%
  numeric o, l, m ; path a, b ; pair c ;
  picture d;
  o := BodyFontSize ;
  if \MPvar{IsOverlay} = 0:
    d = textext.rt(\MPstring{Content}) ;
    
    a := (boundingbox d) enlarged 15pt;%unitsquare xyscaled (OverlayWidth,OverlayHeight);
  else:
  	a := unitsquare xyscaled (OverlayWidth,OverlayHeight);  
  fi;
  l := 1pt  * \MPvar{Value};
  pickup pencircle scaled l ;
  b := a if  \MPvar{Shape} = 1: superellipsed .95; 
  elseif  \MPvar{Shape} = 0: squeezed 2pt; fi;
  fill b withcolor lightgray ;
  draw b withcolor darkred ;
   if \MPvar{IsOverlay} = 0:
draw d withcolor black;
fi;
  if \MPvar{Title} = 1:
    picture q ;
    q := textext.rt(\MPstring{Title}) ;
    if  \MPvar{Shape} = 1:
      q := q shifted (xpart center a-xpart center q, ypart ulcorner a);
      b := (boundingbox q)   superellipsed .95;  
    elseif  \MPvar{Shape} = 0:
        q := q shifted (xpart center a-xpart center q, ypart ulcorner a);
        b := (boundingbox q)  squeezed 2pt;  
    fi;
    fill b withcolor lightgray ;
    pickup pencircle scaled  (2pt * 0.5);
    draw b withcolor darkred ;
    draw q withcolor black ;
  fi;




  if \MPvar{Hypotheses} = 1:
    picture p ;
    p := textext.rt(\MPstring{Hypotheses}) ;
 p := p shifted (xpart center a-xpart center p,ypart llcorner a) ;
    b := (boundingbox p) if  \MPvar{Shape} = 1: enlarged 2pt superellipsed .95; 
     elseif  \MPvar{Shape} = 0: enlarged 2pt squeezed 2pt; fi;
    fill b withcolor lightgray ;
    pickup pencircle scaled  (2pt * 0.5);
    draw b withcolor darkred ;
    draw p withcolor black ;
        
      
  fi;
  
  % setbounds currentpicture to a ;
  % draw boundingbox currentpicture withpen pencircle scaled .1mm dashed evenly ;
\stopusableMPgraphic    

\defineoverlay[OverlayStatement][\useMPgraphic{Frame}]
\defineframedtext[Statement][frame=off]
\setupframedtexts[Statement][backgroundcolor=lightgray,framecolor=darkred,rulethickness=2pt,offset=overlay,before={\blank[big,medium]},after={\blank[big]},width=\textwidth,autowidth=force]


\defineframedtext[Exercice][frame=on]
\setupframedtexts[Exercice][backgroundcolor=lightgray,framecolor=black,rulethickness=1pt,before=,after={\blank[medium]},width=\textwidth,autowidth=force]




\startreusableMPgraphic{name}
fill fullcircle scaled 200pt withcolor .625yellow;
\stopreusableMPgraphic

\definesymbol[Lucifer] [\uniqueMPgraphic{name}]
\setupframedtexts[S][width=\textwidth,autowidth=force]
\defineframedtext[S][frame=off]



\def\Rappel : #1\par{{%
	\eightpoint
	\noindent
	\llap{%
		$\underline{\mbox{Rappel}}$ : 
	}%
	#1\medskip
}}%
\long\def\Rappels. #1\par{\noindent{\eightpoint{\it Rappels. }#1}\medskip}


\def\Remarque#1{\noindent{\it Remarque. }#1\crlf\crlf}%

%\def\Statement{\dosingleargument\Statement@do}%
%\long\def\Statement@do[#1]#2\par{\SetupHypotheses{Frame}{#1}\placefigure[right,nonumber]{}{\startStatement\ignorespaces #2\stopStatement}}%

\def\Tab#1{\starttabulate#1\stoptabulate}%

\def\VTab#1{\vcenter{\Tab{#1}}}%

\def\❮{}
\def\❯{}
\protect
\stopenvironment
