\startenvironment e_Limbo
\unprotect


%\Cursus μMφΦψΨτTθΘβB
% μ m Maths   (MP)
% φ Φ Physics (PC)
% ψ Ψ        (PSI)
% τ t Techno  (PT)
% θ Θ      (TSI)
% β b Bio     (Bcpst)
% βμφτ


% mark up
%
% id
% t for title
% p for program
%
% l for level
% */**
%
% i for index
% u for usage
% */**
%

%% process the Limbo xml files
\startxmlsetups xml:limbo
\xmlsetsetup{maths}{*}{-} 
\xmlsetsetup{maths}{part|chapter|section|subsection|concept|text|definition|example|figure|property|theorem|remark|OL}{xml:*} 
\stopxmlsetups 

\xmlregistersetup{xml:limbo} 

\startluacode 
    L = L or {}
  
 L.course = "β"

 function L.setCourse(text)
   L.course = text
 end
 
 function L.getString(node)
  local nodeId = lxml.id(node)
  local data = xml.content(nodeId)
  if string.sub(data, 1, 9) == "<![CDATA[" then 
  	return data.sub(data, 10, string.len(data) -3) 
  else 
  	return data 
  end
end
 
 
function L.isInCourse(node)
  program = xml.filter(lxml.id(node),"xml://./attribute(p)")
  if program~=nil then 
    local test = string.explode(program, "-")
    if test[1] and string.find(test[1], L.course) then return true end
    if test[2] and string.find(test[2], L.course) then return false end
  end
  return true
end

function L.getIndex(node)
  return xml.filter(lxml.id(node),"xml://./attribute(i)")
end

function L.getTitle(node)
  return xml.filter(lxml.id(node),"xml://./attribute(t)")
end

function L.getProgram(node)
  return xml.filter(lxml.id(node),"xml://./attribute(p)")
end


function L.processConcept(node)
  if L.isInCourse(node) then 
    context("\\noindent")
    context.inmargin(L.getTitle(node))
    index = L.getIndex(node)
    if index~= nil then context.index(index) end
    lxml.flush(node)
  end
end

function L.processExample(node)
  if not L.isInCourse(node) then return end
  context("\\Exemple "..L.getString(node))
end

function L.processFigure(node)
  if not L.isInCourse(node) then return end
  context(L.getString(node))
end

function L.processExample(node)
  if not L.isInCourse(node) then return end
  context("\\Exemples "..L.getString(node))
end



function L.processSection(node, command)
  if L.isInCourse(node) then 
    context(command .. "{" .. L.getTitle(node) .. "}")  	
  end
end

function L.processStatement(node, command)
  if not L.isInCourse(node) then return end
  context(command..L.getString(node).. "\\par")
end



function L.processText(node)
  if not L.isInCourse(node) then return end
  context(L.getString(node))
end

function L.processRemark(node)
  if not L.isInCourse(node) then return end
  context("\\Remarque "..L.getString(node))
end

function L.processOL(node)
  if not L.isInCourse(node) then return end
  context("OL: "..L.getString(node))
end
\stopluacode 



\startxmlsetups xml:part
\xmlflush{#1}
\stopxmlsetups 

\def\isOfCourse#1{}

\def\getIndex#1{[[\xmlatt{#1}{i}]]}
\def\getProgram#1{[[\xmlatt{#1}{p}]]}
\def\getTitle#1{[[\xmlatt{#1}{t}]]}

\startxmlsetups xml:chapter
\ctxlua{L.processSection("#1", "\\chapter ")}%
\stopxmlsetups

\startxmlsetups xml:section
\ctxlua{L.processSection("#1", "\\section ")}%
\stopxmlsetups

\startxmlsetups xml:subsection
\ctxlua{L.processSection("#1", "\\subsection ")}%
\stopxmlsetups

\startxmlsetups xml:concept
\ctxlua{L.processConcept("#1")}%
\stopxmlsetups

\startxmlsetups xml:text
\ctxlua{L.processText("#1")}%
\stopxmlsetups 

\startxmlsetups xml:definition
\ctxlua{L.processStatement("#1", "\\Définition ")}%
\stopxmlsetups

\startxmlsetups xml:example
\ctxlua{L.processExample("#1")}%
\stopxmlsetups

\startxmlsetups xml:figure
\ctxlua{L.processFigure("#1")}%
\stopxmlsetups

\startxmlsetups xml:property
\ctxlua{L.processStatement("#1", "\\Propriété ")}%
\stopxmlsetups

\startxmlsetups xml:theorem
\ctxlua{L.processStatement("#1", "\\Théorème ")}%
\stopxmlsetups

\startxmlsetups xml:OL
\ctxlua{L.processOL("#1")}%
\stopxmlsetups

\def\setupCourse#1{\ctxlua{L.setCourse("#1")}}

%% get knowledge
%\def\S#1{\ctxlua{context(M["#1"])}}%
%\setupinmargin[width=fit]
\protect
\stopenvironment
